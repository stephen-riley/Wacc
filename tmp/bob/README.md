# Bob

These are artifacts from trying to figure out how to take a .S file and be able to debug it with lldb.  The labels (like `_main`) are in the `.dSYM` package generated by gcc, and the source mappings are in there, but lldb doesn't recognize them.  Need to figure out why, since all the documentation online says it should "just work".

**UPDATE:**

Turns out that on macOS, if you assemble and link in a single command, `dsymutil` is automatically invoked at the end and the useful debug info like the source map is *stripped* from the executable.  

If you do it in two invocations--one to assemble to an object file, and one to link--then the debug information stays in the executable.

So this works perfectly:

```bash
gcc -g -c -o ${FILE}.o ${FILE}.s
gcc -o ${FILE} ${FILE}.o -arch arm64
```

At this point I haven't found a way to do it in one invocation that prevents the `dsymutil` call at the end.

## Assemble with source metadata

1. `gcc -g bob.S -o a` generates the executable `a` and the debug imfo `a.dSYM/`
1. `lldb a`
1. `add-dsym ./a.dSYM`
1. `target modules dump symtab a` to show all symbols.  *Note that `_main` became `a``main`!  Looks like the leading `_`s are stripped.
1. `process launch --stop-at-entry` to launch but not run the executable
1. `b main` sets a breakpoint at `_main` in the source `.S` file
1. `c` to run the program.  We "continue" because we already started the process with the `process launch`, above.

## Setting up lldb

1. `echo "settings set target.load-cwd-lldbinit true" > ~/.lldbinit` to allow automatic execution of `.lldbinit` files per-directory.
1. Put the following into `.lldbinit` in the same directory as the executable.  Then when you run lldb, things will be set up for you.

```
target create ./a
add-dsym ./a.dSYM
process launch --stop-at-entry
b main
```

## Setting up CodeLLDB

This is an extension for vscode that makes a kind-of decent debugging environment.

1. Install the `CodeLLDB` extension from the extension marketplace.
2. Create a launch profile like this:

```json
    {
        "name": "Debug bob",
        "type": "lldb",
        "request": "launch",
        "cwd": "${workspaceFolder}/tmp/bob",
        "program": "${workspaceFolder}/tmp/bob/a",
        "args": [],
        "stopOnEntry": true
    }
```

## Misc commands

`dwarfdump a.dSYM` will show a bumch of info from the dSYMs, like the source filenames and their folder path.

```
a.dSYM/Contents/Resources/DWARF/a:      file format Mach-O arm64

.debug_info contents:
0x00000000: Compile Unit: length = 0x0000003b, format = DWARF32, version = 0x0005, unit_type = DW_UT_compile, abbr_offset = 0x0000, addr_size = 0x08 (next unit at 0x0000003f)

0x0000000c: DW_TAG_compile_unit
              DW_AT_stmt_list   (0x00000000)
              DW_AT_name        ("bob.S")
              DW_AT_comp_dir    ("/Users/jsrs701/Projects/Wacc/tmp/bob")
              DW_AT_producer    ("Apple clang version 17.0.0 (clang-1700.0.13.3)")
              DW_AT_language    (DW_LANG_Mips_Assembler)
              DW_AT_str_offsets_base    (0x00000008)
    :
    :
```
